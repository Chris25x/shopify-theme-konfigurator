<section id="section-{{ section.id }}" class="product-grid-tiles">
  <div class="container">
    {% if section.settings.heading != blank %}
      <h1 class="heading">{{ section.settings.heading }}</h1>
    {% endif %}
    {% if section.settings.subheading != blank %}
      <p class="subheading">{{ section.settings.subheading }}</p>
    {% endif %}

    <!-- Filter and Sort Bar -->
    <div class="filter-sort-bar">
      <div class="filter-section">
        <label for="price-filter" class="filter-label">Filter: Preis</label>
        <select class="filter-dropdown" id="price-filter" aria-label="Nach Preis filtern">
          <option value="">Preis</option>
          <option value="low-high">Niedrig zu Hoch</option>
          <option value="high-low">Hoch zu Niedrig</option>
        </select>
        {% if section.settings.show_reihen_filter %}
          <select class="filter-dropdown" id="reihen-filter" aria-label="Nach Reihen filtern">
            <option value="">Alle Reihen</option>
          </select>
        {% endif %}
      </div>
      
      <div class="sort-section">
        <label for="sort-dropdown" class="sort-label">Sortieren nach:</label>
        <select class="sort-dropdown" id="sort-dropdown" aria-label="Sortierung">
          <option value="title-asc">Alphabetisch, A-Z</option>
          <option value="title-desc">Alphabetisch, Z-A</option>
          <option value="price-asc">Preis aufsteigend</option>
          <option value="price-desc">Preis absteigend</option>
        </select>
      </div>
      
      <div class="product-count" id="product-count">
        {% assign products_source = collections[section.settings.collection].products | default: collections.all.products %}
        {% assign product_limit = section.settings.products_to_show %}
        {% assign total_products = products_source.size %}
        {% assign current_page = request.query.page | default: 1 | plus: 0 %}
        {% assign start_index = current_page | minus: 1 | times: product_limit %}
        {% assign end_index = start_index | plus: product_limit | minus: 1 %}
        {% if end_index >= total_products %}
          {% assign end_index = total_products | minus: 1 %}
        {% endif %}
        {% assign display_count = end_index | minus: start_index | plus: 1 %}
        {{ total_products }} Produkte
      </div>
    </div>

    <div class="grid">
      {% comment %} Produkte laden: Entweder aus Collection oder alle {% endcomment %}
      {% if section.settings.collection != blank %}
        {% assign products_source = collections[section.settings.collection].products %}
      {% else %}
        {% assign products_source = collections.all.products %}
      {% endif %}

      {% comment %} Alle Produkte laden für client-seitige Paginierung {% endcomment %}
      {% assign product_limit = section.settings.products_to_show %}
      
      {% for product in products_source %}
        {% comment %} Extrahiere Reihen-Wert für dieses Produkt {% endcomment %}
        {% assign product_reihen = '' %}
        {% if section.settings.show_reihen_filter %}
          {% comment %} 1. Suche nach Reihen in Varianten-Optionen {% endcomment %}
          {% for option in product.options_with_values %}
            {% assign option_name_lower = option.name | downcase %}
            {% if option_name_lower == 'reihen' or option_name_lower contains 'reihe' %}
              {% if option.values.size > 0 %}
                {% assign product_reihen = option.values.first %}
              {% endif %}
            {% endif %}
          {% endfor %}
          
          {% comment %} 2. Falls nicht in Optionen gefunden, prüfe Metafields {% endcomment %}
          {% if product_reihen == '' and product.metafields.custom.reihen %}
            {% assign product_reihen = product.metafields.custom.reihen %}
          {% endif %}
          
          {% comment %} 3. Suche nach "X-reihig" im Produkttitel {% endcomment %}
          {% if product_reihen == '' %}
            {% assign title_lower = product.title | downcase %}
            {% if title_lower contains '-reihig' or title_lower contains 'reihig' %}
              {% comment %} Extrahiere Zahl vor "-reihig" oder "reihig" {% endcomment %}
              {% assign title_parts = title_lower | split: '-reihig' %}
              {% if title_parts.size > 1 %}
                {% assign before_reihig = title_parts.first | split: ' ' | last %}
              {% else %}
                {% assign title_parts2 = title_lower | split: 'reihig' %}
                {% if title_parts2.size > 1 %}
                  {% assign before_reihig = title_parts2.first | split: ' ' | last %}
                {% endif %}
              {% endif %}
              {% if before_reihig contains '10' %}
                {% assign product_reihen = '10-reihig' %}
              {% elsif before_reihig contains '9' %}
                {% assign product_reihen = '9-reihig' %}
              {% elsif before_reihig contains '8' %}
                {% assign product_reihen = '8-reihig' %}
              {% elsif before_reihig contains '7' %}
                {% assign product_reihen = '7-reihig' %}
              {% elsif before_reihig contains '6' %}
                {% assign product_reihen = '6-reihig' %}
              {% elsif before_reihig contains '5' %}
                {% assign product_reihen = '5-reihig' %}
              {% elsif before_reihig contains '4' %}
                {% assign product_reihen = '4-reihig' %}
              {% elsif before_reihig contains '3' %}
                {% assign product_reihen = '3-reihig' %}
              {% elsif before_reihig contains '2' %}
                {% assign product_reihen = '2-reihig' %}
              {% elsif before_reihig contains '1' %}
                {% assign product_reihen = '1-reihig' %}
              {% endif %}
            {% endif %}
          {% endif %}
          
          {% comment %} 4. Suche nach "X-reihig" in Produktbeschreibung {% endcomment %}
          {% if product_reihen == '' and product.description != blank %}
            {% assign desc_lower = product.description | downcase %}
            {% if desc_lower contains '-reihig' %}
              {% assign desc_parts = desc_lower | split: '-reihig' %}
              {% if desc_parts.size > 0 %}
                {% assign before_reihig = desc_parts.first | split: ' ' | last %}
                {% if before_reihig contains '1' %}{% assign product_reihen = '1-reihig' %}
                {% elsif before_reihig contains '2' %}{% assign product_reihen = '2-reihig' %}
                {% elsif before_reihig contains '3' %}{% assign product_reihen = '3-reihig' %}
                {% elsif before_reihig contains '4' %}{% assign product_reihen = '4-reihig' %}
                {% elsif before_reihig contains '5' %}{% assign product_reihen = '5-reihig' %}
                {% elsif before_reihig contains '6' %}{% assign product_reihen = '6-reihig' %}
                {% elsif before_reihig contains '7' %}{% assign product_reihen = '7-reihig' %}
                {% elsif before_reihig contains '8' %}{% assign product_reihen = '8-reihig' %}
                {% elsif before_reihig contains '9' %}{% assign product_reihen = '9-reihig' %}
                {% elsif before_reihig contains '10' %}{% assign product_reihen = '10-reihig' %}
                {% endif %}
              {% endif %}
            {% endif %}
          {% endif %}
          
          {% comment %} 5. Suche nach "X-reihig" in Tags {% endcomment %}
          {% if product_reihen == '' and product.tags.size > 0 %}
            {% for tag in product.tags %}
              {% assign tag_lower = tag | downcase %}
              {% if tag_lower contains '-reihig' %}
                {% assign product_reihen = tag %}
                {% break %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endif %}
        
        <a
          href="{{ product.url }}"
          class="product-card"
          aria-label="{{ product.title | escape }}"
          data-product-title="{{ product.title | escape }}"
          data-product-price="{{ product.price }}"
          data-product-id="{{ product.id }}"
          {% if section.settings.show_reihen_filter and product_reihen != blank %}data-product-reihen="{{ product_reihen }}"{% endif %}
        >
          <div class="product-card__image-container">
            {% if product.featured_image %}
              {% liquid
                assign gap_size = section.settings.gap | default: 20
                assign columns_mobile = section.settings.columns_mobile | default: 2 | plus: 0
                assign columns_tablet = section.settings.columns_tablet | default: 3 | plus: 0
                assign columns_desktop = section.settings.columns_desktop | default: 4 | plus: 0
                
                assign mobile_percent = 100 | divided_by: columns_mobile
                assign tablet_percent = 100 | divided_by: columns_tablet
                assign desktop_percent = 100 | divided_by: columns_desktop
              %}
              <img
                src="{{ product.featured_image | image_url: width: 400 }}"
                srcset="
                  {{ product.featured_image | image_url: width: 250 }} 250w,
                  {{ product.featured_image | image_url: width: 350 }} 350w,
                  {{ product.featured_image | image_url: width: 400 }} 400w,
                  {{ product.featured_image | image_url: width: 500 }} 500w,
                  {{ product.featured_image | image_url: width: 600 }} 600w
                "
                sizes="(min-width: 1280px) calc({{ desktop_percent }}vw - {{ gap_size }}px), (min-width: 768px) calc({{ tablet_percent }}vw - {{ gap_size }}px), calc({{ mobile_percent }}vw - {{ gap_size }}px)"
                alt="{{ product.featured_image.alt | default: product.title | escape }}"
                loading="lazy"
                width="{{ product.featured_image.width | default: 400 }}"
                height="{{ product.featured_image.height | default: 400 }}"
                class="product-card__image"
              />
            {% else %}
              <div class="product-card__placeholder">
                <span class="product-card__placeholder-text">{{ product.title }}</span>
              </div>
            {% endif %}
          </div>

          <div class="product-card__content">
            <div class="product-card__header">
              <h3 class="product-card__title">{{ product.title }}</h3>
            </div>
            
            {% if section.settings.show_price %}
              <div class="product-card__price">
                {% if product.compare_at_price > product.price %}
                  <span class="price--sale">{{ product.price | money }}</span>
                  <span class="price--compare">{{ product.compare_at_price | money }}</span>
                {% else %}
                  <span class="price">{{ product.price | money }}</span>
                {% endif %}
              </div>
            {% endif %}
          </div>
        </a>
      {% else %}
        <div class="empty">
          <p>Keine Produkte gefunden.</p>
        </div>
      {% endfor %}
    </div>

    {% comment %} Paginierung Navigation (JavaScript-basiert) {% endcomment %}
    <div class="pagination" id="pagination" style="display: none;">
      <div class="pagination__nav">
        <button class="pagination__btn pagination__btn--prev" id="prev-page" disabled>
          ← Vorherige
        </button>
        
        <div class="pagination__pages" id="pagination-pages">
          <!-- Seitenzahlen werden durch JavaScript generiert -->
        </div>
        
        <button class="pagination__btn pagination__btn--next" id="next-page">
          Nächste →
        </button>
      </div>
    </div>

    {% if section.settings.show_view_all and section.settings.collection != blank %}
      <div class="view-all">
        <a href="{{ collections[section.settings.collection].url }}" class="btn btn--secondary">
          Alle Produkte anzeigen
        </a>
      </div>
    {% endif %}
  </div>

  {% style %}
    #section-{{ section.id }}{ background: {{ section.settings.section_bg | default: '#ffffff' }}; color: #0f172a; }
    #section-{{ section.id }} .container{ max-width: {{ section.settings.max_width }}px; margin:0 auto; padding: clamp(24px, 3vw, 40px) clamp(16px, 4vw, 50px); }

    #section-{{ section.id }} .heading{ font-size: clamp(28px, 2vw + 8px, 40px); font-weight: 800; margin: 0 0 8px; color: #111827; letter-spacing: -0.02em; }
    #section-{{ section.id }} .subheading{ color:#475569; margin:0 0 24px; max-width: 70ch; font-size: 16px; }

    /* Filter and Sort Bar */
    #section-{{ section.id }} .filter-sort-bar{ 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      gap: 20px; 
      margin-bottom: 32px; 
      padding: 16px 0; 
      border-bottom: 1px solid #e2e8f0; 
      flex-wrap: wrap; 
    }
    
    #section-{{ section.id }} .filter-section{ 
      display: flex; 
      align-items: center; 
      gap: 12px; 
      flex: 1; 
    }
    
    #section-{{ section.id }} .sort-section{ 
      display: flex; 
      align-items: center; 
      gap: 12px; 
    }
    
    #section-{{ section.id }} .filter-label, 
    #section-{{ section.id }} .sort-label{ 
      font-size: 14px; 
      font-weight: 600; 
      color: #374151; 
      white-space: nowrap; 
    }
    
    #section-{{ section.id }} .filter-dropdown, 
    #section-{{ section.id }} .sort-dropdown{ 
      padding: 8px 12px; 
      border: 1px solid #d1d5db; 
      border-radius: 6px; 
      background: #ffffff; 
      font-size: 14px; 
      color: #374151; 
      min-width: 140px; 
      cursor: pointer; 
    }
    
    #section-{{ section.id }} .product-count{ 
      font-size: 14px; 
      font-weight: 500; 
      color: #6b7280; 
      white-space: nowrap; 
    }

    /* Product Grid */
    #section-{{ section.id }} .grid{ 
      display: grid; 
      grid-template-columns: repeat({{ section.settings.columns_mobile }}, 1fr); 
      gap: {{ section.settings.gap }}px; 
    }
    @media (min-width: 768px){ 
      #section-{{ section.id }} .grid{ 
        grid-template-columns: repeat({{ section.settings.columns_tablet | at_least: 2 }}, 1fr); 
      } 
    }
    @media (min-width: 1280px){ 
      #section-{{ section.id }} .grid{ 
        grid-template-columns: repeat({{ section.settings.columns_desktop | at_least: 2 }}, 1fr); 
      } 
    }

    /* Product Cards */
    #section-{{ section.id }} .product-card{ 
      display: block; 
      background: #ffffff; 
      border: 1px solid #e2e8f0; 
      border-radius: 16px; 
      overflow: hidden; 
      box-shadow: 0 1px 2px rgba(2,6,23,.04); 
      text-decoration: none; 
      color: inherit; 
      transition: transform 0.3s ease, box-shadow 0.3s ease; 
    }
    
    #section-{{ section.id }} .product-card:hover{ 
      transform: translateY(-2px); 
      box-shadow: 0 4px 12px rgba(2,6,23,.08); 
    }

    #section-{{ section.id }} .product-card__image-container{ 
      position: relative; 
      width: 100%; 
      aspect-ratio: 4/3; 
      background: #ffffff; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      overflow: hidden; 
    }
    
    #section-{{ section.id }} .product-card__image{ 
      width: 100%; 
      height: 100%; 
      object-fit: contain; 
      transition: transform 0.3s ease; 
    }
    
    #section-{{ section.id }} .product-card:hover .product-card__image{ 
      transform: scale(1.05); 
    }
    
    #section-{{ section.id }} .product-card__placeholder{ 
      width: 100%; 
      height: 100%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      background: #ffffff; 
    }
    
    #section-{{ section.id }} .product-card__placeholder-text{ 
      font-size: 18px; 
      font-weight: 600; 
      color: #9ca3af; 
      text-align: center; 
      padding: 20px; 
    }

    #section-{{ section.id }} .product-card__content{ 
      padding: 16px; 
    }
    
    #section-{{ section.id }} .product-card__header{ 
      display: flex; 
      justify-content: space-between; 
      align-items: flex-start; 
      margin-bottom: 8px; 
      gap: 12px; 
    }
    
    #section-{{ section.id }} .product-card__title{ 
      font-size: 16px; 
      font-weight: 600; 
      color: #111827; 
      line-height: 1.3; 
      margin: 0; 
      flex: 1; 
      min-width: 0; /* Ermöglicht Textumbruch */
      word-wrap: break-word;
      hyphens: auto;
    }
    
    
    
    
    #section-{{ section.id }} .product-card__price{ 
      font-size: 16px; 
      font-weight: 700; 
      color: #111827; 
    }
    
    #section-{{ section.id }} .price--sale{ 
      color: #dc2626; 
    }
    
    #section-{{ section.id }} .price--compare{ 
      font-size: 14px; 
      font-weight: 400; 
      color: #64748b; 
      text-decoration: line-through; 
      margin-left: 8px; 
    }

    /* View All Button */
    #section-{{ section.id }} .view-all{ margin-top: 32px; text-align: center; }
    #section-{{ section.id }} .btn{ display: inline-block; padding: 12px 32px; font-size: 16px; font-weight: 600; border-radius: 8px; text-decoration: none; transition: all 0.2s ease; }
    #section-{{ section.id }} .btn--secondary{ background: #fff; color: #0f172a; border: 2px solid #e2e8f0; }
    #section-{{ section.id }} .btn--secondary:hover{ background: #f1f5f9; border-color: #cbd5e1; }

    /* Empty state */
    #section-{{ section.id }} .empty{ background:#fff; border:1px solid #e2e8f0; border-radius:16px; padding:32px; color:#475569; text-align:center; grid-column: 1 / -1; }

    /* Pagination */
    #section-{{ section.id }} .pagination{ 
      margin-top: 32px; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
    }
    
    #section-{{ section.id }} .pagination__nav{ 
      display: flex; 
      align-items: center; 
      gap: 8px; 
    }
    
    #section-{{ section.id }} .pagination__btn, 
    #section-{{ section.id }} .pagination__page{ 
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
      min-width: 40px; 
      height: 40px; 
      padding: 8px 12px; 
      border: 1px solid #d1d5db; 
      border-radius: 6px; 
      background: #ffffff; 
      color: #374151; 
      text-decoration: none; 
      font-size: 14px; 
      font-weight: 500; 
      transition: all 0.2s ease; 
      cursor: pointer; 
    }
    
    #section-{{ section.id }} .pagination__btn:disabled{ 
      opacity: 0.5; 
      cursor: not-allowed; 
    }
    
    #section-{{ section.id }} .pagination__pages{ 
      display: flex; 
      gap: 4px; 
    }
    
    #section-{{ section.id }} .pagination__btn:hover, 
    #section-{{ section.id }} .pagination__page:hover{ 
      background: #f3f4f6; 
      border-color: #9ca3af; 
    }
    
    #section-{{ section.id }} .pagination__page--current{ 
      background: #3b82f6; 
      border-color: #3b82f6; 
      color: #ffffff; 
    }
    
    #section-{{ section.id }} .pagination__page--current:hover{ 
      background: #2563eb; 
      border-color: #2563eb; 
    }

    /* Responsive adjustments */
    @media (max-width: 767px) {
      #section-{{ section.id }} .filter-sort-bar{ 
        flex-direction: column; 
        align-items: stretch; 
        gap: 10px; 
        padding: 8px 0;
      }
      
      #section-{{ section.id }} .filter-section{ 
        display: flex;
        flex-direction: row;
        align-items: flex-end;
        gap: 8px;
        width: 100%;
        flex-wrap: wrap;
      }
      
      #section-{{ section.id }} .filter-section .filter-label {
        display: none; /* Label ausblenden, da visuell verborgen */
      }
      
      #section-{{ section.id }} .filter-dropdown {
        flex: 1;
        min-width: 0 !important;
        width: auto;
        max-width: none;
        box-sizing: border-box;
        font-size: 12px;
        padding: 6px 10px;
      }
      
      /* Wenn nur ein Filter, volle Breite */
      #section-{{ section.id }} .filter-section .filter-dropdown:only-of-type {
        flex: 1 1 100%;
      }
      
      #section-{{ section.id }} .sort-section{ 
        flex-direction: column;
        align-items: stretch;
        gap: 6px;
        width: 100%;
      }
      
      #section-{{ section.id }} .sort-label {
        font-size: 11px;
        margin-bottom: 2px;
      }
      
      #section-{{ section.id }} .sort-dropdown {
        min-width: 100% !important;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        font-size: 12px;
        padding: 6px 10px;
      }
      
      #section-{{ section.id }} .product-count{ 
        text-align: center; 
        font-size: 11px;
        padding-top: 6px;
        border-top: 1px solid #e2e8f0;
      }
      
      /* Mobile-spezifische Verbesserungen für Produktkarten */
      #section-{{ section.id }} .product-card__header{ 
        flex-direction: column; 
        align-items: flex-start; 
        gap: 8px; 
      }
      
      #section-{{ section.id }} .product-card__title{ 
        font-size: 14px; 
        line-height: 1.4; 
        width: 100%; 
        flex: none; 
        margin-bottom: 4px; 
      }
      
      
      #section-{{ section.id }} .product-card__content{ 
        padding: 12px; 
      }
    }

    /* Filter states */
    #section-{{ section.id }} .product-card.hidden {
      display: none;
    }
  {% endstyle %}

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const sectionId = 'section-{{ section.id }}';
      const productCards = document.querySelectorAll(`#${sectionId} .product-card`);
      const reihenFilter = document.getElementById('reihen-filter');
      const priceFilter = document.getElementById('price-filter');
      const sortDropdown = document.getElementById('sort-dropdown');
      const productCount = document.getElementById('product-count');
      const grid = document.querySelector(`#${sectionId} .grid`);
      const pagination = document.getElementById('pagination');
      const paginationPages = document.getElementById('pagination-pages');
      const prevBtn = document.getElementById('prev-page');
      const nextBtn = document.getElementById('next-page');

      // Paginierung Variablen
      const productsPerPage = {{ section.settings.products_to_show }};
      let currentPage = 1;
      let filteredAndSortedProducts = Array.from(productCards);
      let totalPages = 1;

      // Sammle verfügbare Reihen-Werte für den Filter
      {% if section.settings.show_reihen_filter %}
      if (reihenFilter) {
        const reihenValues = new Set();
        productCards.forEach(card => {
          const reihen = card.dataset.productReihen;
          if (reihen && reihen.trim() !== '') {
            reihenValues.add(reihen.trim());
          }
        });
        
        // Sortiere und füge Optionen hinzu
        const sortedReihen = Array.from(reihenValues).sort((a, b) => {
          const numA = parseInt(a) || 0;
          const numB = parseInt(b) || 0;
          return numA - numB;
        });
        
        sortedReihen.forEach(reihe => {
          const option = document.createElement('option');
          option.value = reihe;
          option.textContent = reihe;
          reihenFilter.appendChild(option);
        });
      }
      {% endif %}


      function updateProductCount() {
        const visibleProducts = document.querySelectorAll(`#${sectionId} .product-card:not(.hidden)`);
        const totalProducts = filteredAndSortedProducts.length;
        const startIndex = (currentPage - 1) * productsPerPage + 1;
        const endIndex = Math.min(currentPage * productsPerPage, totalProducts);
        productCount.textContent = `${endIndex - startIndex + 1} von ${totalProducts} Produkten`;
      }

      function updatePagination() {
        const totalProducts = filteredAndSortedProducts.length;
        totalPages = Math.ceil(totalProducts / productsPerPage);
        
        if (totalPages <= 1) {
          pagination.style.display = 'none';
          return;
        }
        
        pagination.style.display = 'flex';
        
        // Vorherige/Nächste Buttons
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages;
        
        // Seitenzahlen generieren
        paginationPages.innerHTML = '';
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        
        for (let i = startPage; i <= endPage; i++) {
          const pageBtn = document.createElement('button');
          pageBtn.className = `pagination__page ${i === currentPage ? 'pagination__page--current' : ''}`;
          pageBtn.textContent = i;
          pageBtn.addEventListener('click', () => goToPage(i));
          paginationPages.appendChild(pageBtn);
        }
      }

      function goToPage(page) {
        currentPage = page;
        displayProducts();
        updateProductCount();
        updatePagination();
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function displayProducts() {
        // Alle Produkte verstecken
        productCards.forEach(card => card.style.display = 'none');
        
        // Aktuelle Seite anzeigen
        const startIndex = (currentPage - 1) * productsPerPage;
        const endIndex = startIndex + productsPerPage;
        
        for (let i = startIndex; i < endIndex && i < filteredAndSortedProducts.length; i++) {
          filteredAndSortedProducts[i].style.display = 'block';
        }
      }

      function filterProducts() {
        const reihenValue = reihenFilter ? reihenFilter.value : '';
        const priceValue = priceFilter.value;

        filteredAndSortedProducts = Array.from(productCards).filter(card => {
          // Reihen-Filter
          if (reihenValue && reihenFilter) {
            const cardReihen = card.dataset.productReihen || '';
            const cardTitle = card.dataset.productTitle || '';
            const cardTitleLower = cardTitle.toLowerCase();
          
            // Prüfe data-product-reihen Attribut
            if (cardReihen && cardReihen === reihenValue) {
              // Match gefunden, weiter mit diesem Produkt
            } 
            // Prüfe auch im Titel nach "X-reihig"
            else if (reihenValue.includes('-reihig')) {
              const searchNum = reihenValue.replace(/\D/g, '');
              const titleMatch = cardTitleLower.match(/(\d+)-?reihig/);
              if (titleMatch && titleMatch[1] === searchNum) {
                // Match gefunden
              } else {
                return false; // Kein Match
              }
            } else if (cardReihen && cardReihen.includes(reihenValue)) {
              // Partielle Übereinstimmung
            } else if (cardTitleLower.includes(reihenValue.toLowerCase())) {
              // Im Titel gefunden
            } else {
              return false; // Kein Match gefunden
            }
          }
          
          return true;
        });

        // Sortierung anwenden
        sortProducts();
        
        // Zur ersten Seite zurücksetzen
        currentPage = 1;
        
        // Produkte anzeigen und Paginierung aktualisieren
        displayProducts();
        updateProductCount();
        updatePagination();
      }

      function sortProducts() {
        const sortValue = sortDropdown.value;
        
        filteredAndSortedProducts.sort((a, b) => {
          switch (sortValue) {
            case 'title-asc':
              return a.dataset.productTitle.localeCompare(b.dataset.productTitle);
            case 'title-desc':
              return b.dataset.productTitle.localeCompare(a.dataset.productTitle);
            case 'price-asc':
              return parseInt(a.dataset.productPrice) - parseInt(b.dataset.productPrice);
            case 'price-desc':
              return parseInt(b.dataset.productPrice) - parseInt(a.dataset.productPrice);
            default:
              return 0;
          }
        });

        // Karten in neuer Reihenfolge in das Grid einfügen
        filteredAndSortedProducts.forEach(card => {
          grid.appendChild(card);
        });
      }

      // Event Listeners
      if (reihenFilter) {
        reihenFilter.addEventListener('change', filterProducts);
      }
      priceFilter.addEventListener('change', function() {
        if (this.value === 'low-high') {
          sortDropdown.value = 'price-asc';
        } else if (this.value === 'high-low') {
          sortDropdown.value = 'price-desc';
        }
        filterProducts();
      });
      sortDropdown.addEventListener('change', function() {
        // Preis-Filter zurücksetzen wenn Sortierung geändert wird
        if (this.value === 'price-asc' || this.value === 'price-desc') {
          priceFilter.value = this.value === 'price-asc' ? 'low-high' : 'high-low';
        } else {
          priceFilter.value = '';
        }
        
        // Sortierung anwenden
        sortProducts();
        
        // Zur ersten Seite zurücksetzen
        currentPage = 1;
        
        // Produkte anzeigen und Paginierung aktualisieren
        displayProducts();
        updateProductCount();
        updatePagination();
      });

      // Paginierung Event Listeners
      prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          goToPage(currentPage - 1);
        }
      });

      nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
          goToPage(currentPage + 1);
        }
      });

      // Initialisierung - Sortierung zuerst anwenden
      sortProducts();
      displayProducts();
      updateProductCount();
      updatePagination();
    });
  </script>
</section>

{% schema %}
{
  "name": "Product Grid Tiles",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "header",
      "content": "Überschriften"
    },
    { "type": "text", "id": "heading", "label": "Überschrift", "default": "Unsere Produkte" },
    { "type": "text", "id": "subheading", "label": "Untertitel", "default": "Entdecke unsere Produktpalette" },

    {
      "type": "header",
      "content": "Produktauswahl"
    },
    { 
      "type": "collection", 
      "id": "collection", 
      "label": "Kollektion", 
      "info": "Leer lassen, um alle Produkte anzuzeigen" 
    },
    { 
      "type": "range", 
      "id": "products_to_show", 
      "min": 4, 
      "max": 50, 
      "step": 2, 
      "label": "Anzahl der Produkte", 
      "default": 12 
    },
    { 
      "type": "checkbox", 
      "id": "show_view_all", 
      "label": "\"Alle anzeigen\" Button anzeigen", 
      "default": true,
      "info": "Nur sichtbar wenn eine Kollektion ausgewählt ist"
    },

    {
      "type": "header",
      "content": "Layout"
    },
    { "type": "range", "id": "max_width", "min": 900, "max": 1600, "step": 50, "unit": "px", "label": "Container Breite", "default": 1400 },
    { "type": "color", "id": "section_bg", "label": "Hintergrund (Section)", "default": "#f8fafc" },

    { "type": "select", "id": "columns_mobile", "label": "Spalten (Mobil)", "default": "2", "options": [
      { "value": "1", "label": "1 Spalte" },
      { "value": "2", "label": "2 Spalten" }
    ]},
    { "type": "select", "id": "columns_tablet", "label": "Spalten (Tablet)", "default": "3", "options": [
      { "value": "2", "label": "2 Spalten" },
      { "value": "3", "label": "3 Spalten" },
      { "value": "4", "label": "4 Spalten" }
    ]},
    { "type": "select", "id": "columns_desktop", "label": "Spalten (Desktop)", "default": "4", "options": [
      { "value": "2", "label": "2 Spalten" },
      { "value": "3", "label": "3 Spalten" },
      { "value": "4", "label": "4 Spalten" },
      { "value": "5", "label": "5 Spalten" }
    ]},

    {
      "type": "header",
      "content": "Kachel-Styling"
    },
    { "type": "select", "id": "aspect_ratio", "label": "Bild Seitenverhältnis", "default": "4-3", "options": [
      { "value": "16-10", "label": "16:10" },
      { "value": "4-3", "label": "4:3 (empfohlen)" },
      { "value": "1-1", "label": "1:1" }
    ]},
    { "type": "select", "id": "tile_radius", "label": "Eckenradius", "default": "m", "options": [
      { "value": "none", "label": "0" },
      { "value": "m", "label": "12px (empfohlen)" },
      { "value": "l", "label": "16px" },
      { "value": "xl", "label": "24px" }
    ]},
    { "type": "select", "id": "tile_bg_style", "label": "Kachel Hintergrund", "default": "white", "options": [
      { "value": "light", "label": "Hell (slate-100)" },
      { "value": "white", "label": "Weiß" }
    ]},

    { "type": "range", "id": "gap", "min": 8, "max": 32, "step": 2, "unit": "px", "label": "Kachelabstand", "default": 20 },
    { "type": "range", "id": "image_padding", "min": 0, "max": 40, "step": 2, "unit": "px", "label": "Bild-Innenabstand", "default": 16 },

    {
      "type": "header",
      "content": "Produktinformationen"
    },
    { "type": "checkbox", "id": "show_price", "label": "Preis anzeigen", "default": true },
    { "type": "checkbox", "id": "show_reihen_filter", "label": "Reihefilter", "default": false },
    { "type": "select", "id": "image_fit", "label": "Bildmodus", "default": "contain", "options": [
      { "value": "contain", "label": "Contain (empfohlen)" },
      { "value": "cover",   "label": "Cover" }
    ]}
  ],
  "presets": [
    {
      "name": "Product Grid Tiles"
    }
  ]
}
{% endschema %}

