{{ 'component-card.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}

{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }

  /* Custom Related Products Styling */
  .related-products-custom {
    background: {{ section.settings.background_color | default: '#ffffff' }};
  }

  .related-products-custom__heading {
    font-size: {{ section.settings.heading_size | default: '18px' }};
    font-weight: {{ section.settings.heading_weight | default: '600' }};
    margin-bottom: 12px;
    color: {{ section.settings.heading_color | default: '#111827' }};
  }

  .related-products-custom__grid {
    display: grid;
    gap: 16px;
    grid-template-columns: repeat({{ section.settings.columns_mobile | default: 2 }}, 1fr);
  }

  @media screen and (min-width: 750px) {
    .related-products-custom__grid {
      grid-template-columns: repeat({{ section.settings.columns_desktop | default: 4 }}, 1fr);
    }
  }

  .related-product-card {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 16px;
    overflow: hidden;
    transition: all 0.2s ease;
    text-decoration: none;
    color: inherit;
    display: flex;
    flex-direction: column;
    height: 100%;
  }

  .related-product-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    text-decoration: none;
    color: inherit;
  }

  .related-product-card__image-container {
    position: relative;
    aspect-ratio: 4/3;
    background: white;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .related-product-card__image {
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: 12px;
  }

  .related-product-card__content {
    padding: 16px;
    display: flex;
    flex-direction: column;
    flex-grow: 1;
  }

  .related-product-card__title {
    font-weight: 500;
    font-size: 14px;
    line-height: 1.4;
    margin: 0 0 8px 0;
    color: #111827;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-decoration: none;
  }

  .related-product-card__title:hover {
    text-decoration: underline;
    color: #111827;
  }

  .related-product-card__price {
    color: #6b7280;
    font-size: 14px;
    margin: 0 0 12px 0;
    font-weight: 500;
  }

  .related-product-card__button {
    width: 100%;
    border: 1px solid #e5e7eb !important;
    border-radius: 16px;
    padding: 10px 16px;
    background: white;
    color: #374151;
    font-weight: 500;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-block;
    text-align: center;
    min-height: 44px;
    margin-top: auto;
    box-shadow: none;
  }

  .related-product-card__button:hover {
    background: #f9fafb;
    border: 1px solid #d1d5db !important;
    color: #111827;
    text-decoration: none;
  }

  .related-product-card__button:active {
    transform: translateY(1px);
  }

  .related-product-card__button:focus {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
  }

  .related-product-card__button--loading {
    background: #f3f4f6;
    color: #9ca3af;
    cursor: not-allowed;
    border: 1px solid #e5e7eb !important;
  }

  .related-product-card__button--success {
    background: #10b981;
    border: 1px solid #10b981 !important;
    color: white;
  }

  .related-product-card__button--error {
    background: #ef4444;
    border: 1px solid #ef4444 !important;
    color: white;
  }

  .related-product-card__placeholder {
    color: #9ca3af;
    font-size: 14px;
  }
{%- endstyle -%}

<div class="related-products-custom page-width section-{{ section.id }}-padding">
  <product-recommendations
    class="related-products-custom__container"
    data-url="{{ routes.product_recommendations_url }}?limit={{ section.settings.products_to_show | default: 4 }}"
    data-section-id="{{ section.id }}"
    data-product-id="{{ product.id }}"
  >
    {% if recommendations.performed and recommendations.products_count > 0 %}
      <h2 class="related-products-custom__heading">
        {{ section.settings.heading | default: 'Passend dazu' }}
      </h2>
      
      <div class="related-products-custom__grid">
        {% for recommendation in recommendations.products limit: section.settings.products_to_show %}
          <article class="related-product-card" data-product-id="{{ recommendation.id }}">
            <!-- Product Image -->
            <div class="related-product-card__image-container">
              {% if recommendation.featured_media %}
                <img
                  src="{{ recommendation.featured_media | image_url: width: 400 }}"
                  alt="{{ recommendation.featured_media.alt | escape }}"
                  class="related-product-card__image"
                  loading="lazy"
                  width="400"
                  height="300"
                >
              {% else %}
                <span class="related-product-card__placeholder">Bild</span>
              {% endif %}
            </div>

            <!-- Product Content -->
            <div class="related-product-card__content">
              <!-- Product Title -->
              <a 
                href="{{ recommendation.url }}" 
                class="related-product-card__title"
                aria-label="{{ recommendation.title | escape }}"
                title="{{ recommendation.title | escape }}"
              >
                {{ recommendation.title }}
              </a>

              <!-- Product Price -->
              <div class="related-product-card__price">
                {% if recommendation.price %}
                  {{ recommendation.price | money_with_currency }}
                {% else %}
                  Preis auf Anfrage
                {% endif %}
              </div>

              <!-- Add to Cart Button -->
              {% if section.settings.enable_quick_add and recommendation.available %}
                <button 
                  class="related-product-card__button"
                  data-product-id="{{ recommendation.id }}"
                  data-variant-id="{{ recommendation.selected_or_first_available_variant.id }}"
                  data-product-url="{{ recommendation.url }}"
                  aria-label="{{ recommendation.title | escape }} hinzufügen"
                  onclick="handleRelatedProductAdd(this)"
                >
                  Hinzufügen
                </button>
              {% else %}
                <a 
                  href="{{ recommendation.url }}" 
                  class="related-product-card__button"
                  aria-label="Zu {{ recommendation.title | escape }}"
                >
                  Ansehen
                </a>
              {% endif %}
            </div>
          </article>
        {% endfor %}
      </div>
    {% endif %}
  </product-recommendations>
</div>

<script>
  // Related Products Quick Add Functionality
  function handleRelatedProductAdd(button) {
    const productId = button.dataset.productId;
    const variantId = button.dataset.variantId;
    const productUrl = button.dataset.productUrl;
    
    if (!productId || !variantId) {
      console.error('Missing product or variant ID');
      return;
    }

    // Button loading state
    const originalText = button.textContent;
    button.textContent = 'Wird hinzugefügt...';
    button.className = 'related-product-card__button related-product-card__button--loading';
    button.disabled = true;

    // Add to cart
    fetch('/cart/add.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        id: variantId,
        quantity: 1
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 422) {
        throw new Error(data.description || 'Product could not be added to cart');
      }
      
      // Success state
      button.textContent = 'Hinzugefügt!';
      button.className = 'related-product-card__button related-product-card__button--success';
      
      // Trigger cart update event
      document.dispatchEvent(new CustomEvent('cart:refresh'));
      
      // Show success message
      showNotification('Produkt wurde zum Warenkorb hinzugefügt!', 'success');
      
      // Reset button after delay
      setTimeout(() => {
        button.textContent = originalText;
        button.className = 'related-product-card__button';
        button.disabled = false;
      }, 2000);
      
    })
    .catch(error => {
      console.error('Error adding product to cart:', error);
      
      // Error state
      button.textContent = 'Fehler';
      button.className = 'related-product-card__button related-product-card__button--error';
      
      // Show error message
      showNotification('Produkt konnte nicht hinzugefügt werden', 'error');
      
      // Reset button after delay
      setTimeout(() => {
        button.textContent = originalText;
        button.className = 'related-product-card__button';
        button.disabled = false;
      }, 2000);
    });
  }

  // Simple notification system
  function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existing = document.querySelector('.related-products-notification');
    if (existing) existing.remove();

    // Create notification
    const notification = document.createElement('div');
    notification.className = 'related-products-notification';
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 9999;
      font-size: 14px;
      font-weight: 500;
      max-width: 300px;
      animation: slideInRight 0.3s ease;
    `;
    notification.textContent = message;

    // Add animation
    if (!document.querySelector('#notification-animations')) {
      const style = document.createElement('style');
      style.id = 'notification-animations';
      style.textContent = `
        @keyframes slideInRight {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
      `;
      document.head.appendChild(style);
    }

    document.body.appendChild(notification);

    // Auto remove after 3 seconds
    setTimeout(() => {
      notification.style.animation = 'slideInRight 0.3s ease reverse';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 300);
    }, 3000);
  }

  // Listen for cart updates
  document.addEventListener('cart:refresh', function() {
    // Trigger cart drawer update if it exists
    if (window.cartDrawer && typeof window.cartDrawer.refresh === 'function') {
      window.cartDrawer.refresh();
    }
  });
</script>

{% schema %}
{
  "name": "Related Products Custom",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Überschrift",
      "default": "Passend dazu"
    },
    {
      "type": "range",
      "id": "heading_size",
      "min": 14,
      "max": 32,
      "step": 2,
      "unit": "px",
      "label": "Überschrift-Größe",
      "default": 18
    },
    {
      "type": "select",
      "id": "heading_weight",
      "options": [
        {
          "value": "400",
          "label": "Normal"
        },
        {
          "value": "500",
          "label": "Medium"
        },
        {
          "value": "600",
          "label": "Semibold"
        },
        {
          "value": "700",
          "label": "Bold"
        }
      ],
      "default": "600",
      "label": "Überschrift-Gewichtung"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Überschrift-Farbe",
      "default": "#111827"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 8,
      "step": 1,
      "default": 4,
      "label": "Anzahl der Produkte"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4,
      "label": "Spalten (Desktop)"
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "options": [
        {
          "value": "1",
          "label": "1 Spalte"
        },
        {
          "value": "2",
          "label": "2 Spalten"
        }
      ],
      "default": "2",
      "label": "Spalten (Mobile)"
    },
    {
      "type": "checkbox",
      "id": "enable_quick_add",
      "default": true,
      "label": "Quick Add aktivieren",
      "info": "Zeigt 'Hinzufügen' Button anstatt 'Ansehen'"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Hintergrundfarbe",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Abstände"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding oben",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding unten",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Related Products (Custom)"
    }
  ]
}
{% endschema %}
